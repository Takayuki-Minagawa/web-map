# WebMap プログラム仕様書

## 1. 概要

WebMapは、シンプルで直感的な地図アプリケーションです。無料のOpenStreetMapを使用し、カスタムマーカーの作成・管理機能を提供します。APIキーや外部サーバーは不要で、ローカル環境で完結して動作します。

## 2. 技術仕様

### 2.1 フロントエンド
- **HTML5**: セマンティックマークアップ
- **CSS3**: レスポンシブデザイン、Flexbox、Grid Layout
- **JavaScript (ES6+)**: モジュラー設計、非同期処理
- **Leaflet.js v1.9.4**: 地図表示ライブラリ
- **HTML2Canvas v1.4.1**: スクリーンショット機能

### 2.2 バックエンド
- **Python 3.x**: ローカルHTTPサーバー
- **http.server**: 標準ライブラリによる軽量サーバー

### 2.3 データストレージ
- **localStorage**: ブラウザ内データ永続化
- **JSON**: データ交換フォーマット

### 2.4 外部API
- **OpenStreetMap**: 地図タイル（無料）
- **Nominatim API**: 住所検索（無料、APIキー不要）

## 3. ファイル構成

```
WebMap/
├── index.html          # メインHTMLファイル
├── map.js             # JavaScriptロジック
├── style.css          # スタイルシート
├── server.py          # Pythonサーバー
├── README.md          # 使用方法説明
└── プログラム仕様.md    # 本ドキュメント
```

## 4. 機能仕様

### 4.1 地図表示機能
- **地図エンジン**: Leaflet.js + OpenStreetMap
- **初期表示**: 東京（35.6762, 139.6503）、ズームレベル10
- **操作**: ドラッグ移動、ズーム、クリック
- **レスポンシブ**: PC・タブレット・スマートフォン対応

### 4.2 住所検索機能
- **検索API**: Nominatim（OpenStreetMap）
- **対応言語**: 日本語
- **検索方式**: 段階的検索（完全一致→部分一致→単語分割）
- **検索結果**: 最大5件表示
- **操作**: 検索ボックス入力 + Enterキーまたは検索ボタン

### 4.3 マーカー機能

#### 4.3.1 マーカー作成
- **トリガー**: 地図上クリック
- **設定項目**:
  - タイトル（必須）
  - 説明（任意）
  - アイコン選択（9種類）
- **表示**: カスタムアイコン + タイトルラベル

#### 4.3.2 アイコン種類
| アイコン | 用途 | カラー |
|---------|------|--------|
| 📍 | デフォルト | 赤 |
| 🏠 | 家 | 緑 |
| 🏢 | 職場 | 青 |
| 🍽️ | レストラン | オレンジ |
| 🛒 | ショップ | 紫 |
| 🏥 | 病院 | 赤 |
| 🏫 | 学校 | グレー |
| 🌳 | 公園 | 緑 |
| ⭐ | お気に入り | 黄 |

#### 4.3.3 マーカー編集
- **編集方法**: マーカークリック or 管理画面
- **編集可能項目**: タイトル、説明、アイコン
- **削除**: 個別削除（確認ダイアログ付き）

### 4.4 マーカー管理機能

#### 4.4.1 データ永続化
- **保存方式**: localStorage
- **保存タイミング**: 作成・編集・削除時に自動保存
- **データ形式**: JSON

#### 4.4.2 マーカー一覧
- **表示内容**: アイコン、タイトル、説明、座標
- **操作**: 移動、編集、削除

#### 4.4.3 インポート/エクスポート
- **エクスポート**: JSONファイルとしてダウンロード
- **インポート**: JSONファイルから復元
- **ファイル名形式**: `webmap_markers_YYYYMMDD_HHMM.json`

### 4.5 画像保存機能
- **方式**: HTML2Canvasによるスクリーンショット
- **対象**: 地図とマーカーのみ（UI要素は非表示）
- **形式**: PNG
- **ファイル名**: `webmap_YYYYMMDD_HHMMSS.png`

### 4.6 都市移動機能
- **プリセット都市**: 東京、大阪、京都
- **ズームレベル**: 12
- **マーカー**: 都市名付きマーカーを自動設置

## 5. ユーザーインターフェース

### 5.1 コントロールパネル（左上）
- 東京ボタン（緑）
- 大阪ボタン（緑）
- 京都ボタン（緑）
- マーカーをクリアボタン（赤）
- 📷 画像保存ボタン（紫）
- 📋 マーカー管理ボタン（オレンジ）

### 5.2 検索ボックス（右上）
- 住所入力フィールド
- 検索ボタン
- 検索結果表示エリア

### 5.3 情報パネル（右下）
- クリック位置表示
- ズームレベル表示

### 5.4 ダイアログ
- **マーカー設定ダイアログ**: タイトル、説明、アイコン選択
- **マーカー管理ダイアログ**: 一覧表示、インポート/エクスポート

## 6. データ構造

### 6.1 マーカーデータ
```json
{
  "id": 1,
  "title": "マーカータイトル",
  "description": "マーカーの説明",
  "iconType": "home",
  "emoji": "🏠",
  "lat": 35.6762,
  "lng": 139.6503
}
```

### 6.2 都市データ
```javascript
const CITIES = {
  tokyo: { lat: 35.6762, lng: 139.6503, name: '東京' },
  osaka: { lat: 34.6937, lng: 135.5023, name: '大阪' },
  kyoto: { lat: 35.0116, lng: 135.7681, name: '京都' }
};
```

## 7. パフォーマンス最適化

### 7.1 フロントエンド最適化
- **DOM要素キャッシュ**: 頻繁に使用する要素をメモリに保持
- **イベント委譲**: 効率的なイベント処理
- **デバウンス処理**: 過度なイベント発火の抑制
- **バッチ処理**: 複数マーカーの一括操作

### 7.2 ネットワーク最適化
- **プリコネクト**: CDNへの事前接続
- **遅延読み込み**: 必要時のみリソース取得
- **キャッシュ活用**: ブラウザキャッシュの有効利用

## 8. セキュリティ考慮事項

### 8.1 データ保護
- **ローカルストレージ**: 機密情報は保存しない
- **XSS対策**: ユーザー入力のサニタイズ
- **CORS設定**: 適切なオリジン制御

### 8.2 プライバシー
- **位置情報**: ユーザーの明示的な許可後のみ取得
- **データ送信**: 外部サーバーへの個人データ送信なし

## 9. ブラウザサポート

### 9.1 対応ブラウザ
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### 9.2 必要機能
- ES6+ JavaScript
- localStorage
- Geolocation API（位置情報取得時）
- HTML5 Canvas（スクリーンショット時）

## 10. 起動方法

### 10.1 サーバー起動
```bash
python3 server.py
```

### 10.2 アクセス
- URL: `http://localhost:8000`
- ポート: 8000
- 自動ブラウザ起動: 有効

## 11. エラーハンドリング

### 11.1 地図読み込みエラー
- エラーメッセージ表示
- 代替タイルサーバーへの切り替え

### 11.2 検索エラー
- ネットワークエラー時の再試行
- 検索結果なしの適切な表示

### 11.3 データ保存エラー
- localStorage容量不足の検出
- ユーザーへの警告表示

## 12. 今後の拡張可能性

### 12.1 機能拡張
- ルート検索
- 距離測定
- 地図スタイル変更
- マーカーカテゴリ分類

### 12.2 技術的改善
- PWA化（オフライン対応）
- TypeScript化
- モジュール分割
- テスト自動化

## 13. ライセンス

### 13.1 使用ライブラリ
- **Leaflet**: BSD-2-Clause License
- **OpenStreetMap**: Open Database License
- **HTML2Canvas**: MIT License

### 13.2 本プロジェクト
- 特定ライセンスなし（学習・個人利用目的）

---

**作成日**: 2025年9月21日
**バージョン**: 1.0
**最終更新**: 2025年9月21日