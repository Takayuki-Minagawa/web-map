# WebMap

WebMap は Leaflet を用いて地図を表示し、地点情報の管理やルート検索が行えるシンプルな Web アプリケーションです。Python の軽量サーバーでローカル実行でき、外部サービスへの課金は発生しません。

## 基本仕様
- 専用のサーバー環境構築は不要で、付属の `server.py` を起動するだけで利用できます。
- 無料の OpenStreetMap／OSRM／Nominatim API を使用し、課金は発生しません。
- ブラウザ内で完結し、マーカー情報はローカルストレージに保存されます。

## 主な機能
- 地図をクリックした地点の緯度・経度と 1/2 メッシュ（9 桁）の地域メッシュコードを表示。
- 東京／大阪／京都へのジャンプボタンや住所検索による移動が可能。
- カスタムアイコン付きマーカーの追加・編集・削除、およびフィルター表示。
- マーカー一覧ダイアログから移動／編集／削除、JSON 形式でのエクスポート・インポートに対応。
- ルート選択ボタンで出発地／到着地を設定し、OSRM API で自動ルート計算（距離・所要時間を表示）。
- 距離・面積計測モードを切り替えて計測結果をパネルに表示。
- ブラウザの Geolocation API を利用した現在地表示（精度円付き）。
- html2canvas を使った地図領域の画像保存。

## 使い方
1. `python3 server.py` を実行してローカルサーバーを起動します（デフォルトで http://localhost:8000/ ）。ポートを変更したい場合は `python3 server.py 8080` のように数値を指定できます。
2. ブラウザが自動で開かない場合は、上記 URL を手動で開きます。
3. 必要に応じてマーカー追加やルート計算、距離計測などの機能を利用してください。

## 注意事項
- ルート検索および住所検索はインターネット接続が必要です。外部 API の利用制限に達した場合は時間をおいて再試行してください。
- 現在地取得は HTTPS 環境または localhost でのみ動作し、ブラウザからの位置情報許可が必要です。
- マーカーのエクスポート／インポートはブラウザのローカルストレージを前提としているため、別ブラウザ間で共有する場合は JSON ファイルを用いてください。
- 指定したポートが使用中の場合は、サーバーが自動的に空いている次のポートへ切り替わります（例: 8000 → 8001）。

---

# プログラム仕様

## 技術仕様

### フロントエンド
- **HTML5**: セマンティックマークアップ
- **CSS3**: レスポンシブデザイン、Flexbox、Grid Layout
- **JavaScript (ES6+)**: モジュラー設計、非同期処理
- **Leaflet.js v1.9.4**: 地図表示ライブラリ
- **HTML2Canvas v1.4.1**: スクリーンショット機能

### バックエンド
- **Python 3.x**: ローカルHTTPサーバー
- **http.server**: 標準ライブラリによる軽量サーバー

### データストレージ
- **localStorage**: ブラウザ内データ永続化
- **JSON**: データ交換フォーマット

### 外部API
- **OpenStreetMap**: 地図タイル（無料）
- **Nominatim API**: 住所検索（無料、APIキー不要）
- **Project OSRM**: ルート検索（無料、APIキー不要、HTTPSアクセス）

## ファイル構成

```
WebMap/
├── index.html          # メインHTMLファイル
├── map.js             # JavaScriptロジック
├── style.css          # スタイルシート
├── server.py          # Pythonサーバー
└── README.md          # 本ドキュメント
```

## 機能仕様

### 地図表示機能
- **地図エンジン**: Leaflet.js + OpenStreetMap
- **初期表示**: 東京（35.6762, 139.6503）、ズームレベル10
- **操作**: ドラッグ移動、ズーム、クリック
- **レスポンシブ**: PC・タブレット・スマートフォン対応

### 住所検索機能
- **検索API**: Nominatim（OpenStreetMap）
- **対応言語**: 日本語
- **検索方式**: 段階的検索（完全一致→部分一致→単語分割）
- **検索結果**: 最大5件表示
- **操作**: 検索ボックス入力 + Enterキーまたは検索ボタン

### マーカー機能

#### マーカー作成
- **トリガー**: 地図上クリック
- **設定項目**:
  - タイトル（必須）
  - 説明（任意）
  - アイコン選択（9種類）
- **表示**: カスタムアイコン + タイトルラベル

#### アイコン種類
| アイコン | 用途 | カラー |
|---------|------|--------|
| 📍 | デフォルト | 赤 |
| 🏠 | 家 | 緑 |
| 🏢 | 職場 | 青 |
| 🍽️ | レストラン | オレンジ |
| 🛒 | ショップ | 紫 |
| 🏥 | 病院 | 赤 |
| 🏫 | 学校 | グレー |
| 🌳 | 公園 | 緑 |
| ⭐ | お気に入り | 黄 |

#### マーカー編集
- **編集方法**: マーカークリック or 管理画面
- **編集可能項目**: タイトル、説明、アイコン
- **削除**: 個別削除（確認ダイアログ付き）

### マーカー管理機能

#### データ永続化
- **保存方式**: localStorage
- **保存タイミング**: 作成・編集・削除時に自動保存
- **データ形式**: JSON

#### マーカー一覧
- **表示内容**: アイコン、タイトル、説明、座標
- **操作**: 移動、編集、削除

#### インポート/エクスポート
- **エクスポート**: JSONファイルとしてダウンロード
- **インポート**: JSONファイルから復元
- **ファイル名形式**: `webmap_markers_YYYYMMDD_HHMM.json`

### 画像保存機能
- **方式**: HTML2Canvasによるスクリーンショット
- **対象**: 地図とマーカーのみ（UI要素は非表示）
- **形式**: PNG
- **ファイル名**: `webmap_YYYYMMDD_HHMMSS.png`

### 都市移動機能
- **プリセット都市**: 東京、大阪、京都
- **ズームレベル**: 12
- **マーカー**: 都市名付きマーカーを自動設置

### 現在地ジャンプ機能
- **取得方式**: Geolocation API（高精度オプション有効）
- **表示内容**: 現在地マーカー + 精度円（±m表記）
- **ズーム**: 精度値に応じて自動調整（14〜16）
- **制約**: HTTPSまたは`localhost`アクセス時のみ利用可能

### 距離・面積計測機能
- **モード**: 距離計測（折れ線）、面積計測（ポリゴン）
- **操作**: 対象モードを選択 → 地図クリックで頂点追加 → 結果は情報パネルに表示
- **結果表示**:
  - 距離: メートル／キロメートル自動切り替え
  - 面積: 平方メートル／平方キロメートル自動切り替え
  - 周長: 面積計測時に同時表示
- **リセット**: 計測リセットボタンでクリア

### ルートガイド機能
- **API**: Project OSRM（driving profile）
- **操作手順**:
  1. 出発地ボタンを押下し地図上をクリック
  2. 到着地ボタンを押下し地図上をクリック
  3. ルート表示ボタンで経路取得（自動でも起動）
- **表示**: ルートポリライン、距離・所要時間を情報パネルに表示
- **補助**: ルートクリアボタンでポイント／ポリラインを削除

### マーカーフィルター機能
- **対象**: 9種類のマーカーアイコン
- **操作**: フィルタードロップダウンで種類選択、フィルター解除ボタンで全表示
- **反映範囲**: 地図上のマーカー、マーカー管理ダイアログ、情報パネルの件数
- **状態表示**: 「マーカー表示」欄に現在の絞り込み状況と件数を表示

### 地域メッシュコード表示機能
- **メッシュコード体系**: 日本の地域メッシュ統計（JIS X 0410）準拠
- **表示形式**: 9桁の1/2メッシュコード（約500m四方）
- **計算方式**:
  - 1次メッシュ（4桁）: 約80km四方
  - 2次メッシュ（6桁）: 約10km四方
  - 3次メッシュ（8桁）: 約1km四方
  - 1/2メッシュ（9桁）: 約500m四方（3次メッシュを2×2分割）
- **表示位置**: 情報パネル内「メッシュコード」欄
- **更新タイミング**: 地図上をクリックした際に自動計算・表示

## ユーザーインターフェース

### コントロールパネル（左上）
- 東京 / 大阪 / 京都 ボタン（緑）
- マーカーをクリアボタン（赤）
- マーカーフィルター選択（ドロップダウン + 解除ボタン）
- ルート制御（出発地 / 到着地 / ルート表示 / ルートクリア）
- 計測制御（距離計測 / 面積計測 / 計測リセット）
- 📍 現在地ボタン（青）
- 📷 画像保存ボタン（紫）
- 📋 マーカー管理ボタン（オレンジ）

### 検索ボックス（右上）
- 住所入力フィールド
- 検索ボタン
- 検索結果表示エリア

### 情報パネル（右下）
- クリック位置（緯度・経度を6桁精度で表示）
- メッシュコード（9桁の1/2メッシュコード）
- ズームレベル
- 現在地ステータス（成功／失敗／未取得）
- 計測結果（距離・面積・周長）
- マーカー表示状態（フィルター種別・件数）
- ルート結果（距離・所要時間）

### ダイアログ
- **マーカー設定ダイアログ**: タイトル、説明、アイコン選択
- **マーカー管理ダイアログ**: 一覧表示、インポート/エクスポート

## データ構造

### マーカーデータ
```json
{
  "id": 1,
  "title": "マーカータイトル",
  "description": "マーカーの説明",
  "iconType": "home",
  "emoji": "🏠",
  "lat": 35.6762,
  "lng": 139.6503
}
```

### 都市データ
```javascript
const CITIES = {
  tokyo: { lat: 35.6762, lng: 139.6503, name: '東京' },
  osaka: { lat: 34.6937, lng: 135.5023, name: '大阪' },
  kyoto: { lat: 35.0116, lng: 135.7681, name: '京都' }
};
```

## パフォーマンス最適化

### フロントエンド最適化
- **DOM要素キャッシュ**: 頻繁に使用する要素をメモリに保持
- **イベント委譲**: 効率的なイベント処理
- **デバウンス処理**: 過度なイベント発火の抑制
- **バッチ処理**: 複数マーカーの一括操作

### ネットワーク最適化
- **プリコネクト**: CDNへの事前接続
- **遅延読み込み**: 必要時のみリソース取得
- **キャッシュ活用**: ブラウザキャッシュの有効利用

## セキュリティ考慮事項

### データ保護
- **ローカルストレージ**: 機密情報は保存しない
- **XSS対策**: ユーザー入力のサニタイズ
- **CORS設定**: 適切なオリジン制御

### プライバシー
- **位置情報**: ユーザーの明示的な許可後のみ取得
- **データ送信**: 外部サーバーへの個人データ送信なし

## ブラウザサポート

### 対応ブラウザ
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### 必要機能
- ES6+ JavaScript
- localStorage
- Geolocation API（位置情報取得時）
- HTML5 Canvas（スクリーンショット時）

## エラーハンドリング

### 地図読み込みエラー
- エラーメッセージ表示
- 代替タイルサーバーへの切り替え

### 検索エラー
- ネットワークエラー時の再試行
- 検索結果なしの適切な表示

### データ保存エラー
- localStorage容量不足の検出
- ユーザーへの警告表示

## 今後の拡張可能性

### 機能拡張
- 地図スタイル切り替え（ライト／ダーク）
- オフライン閲覧用タイルキャッシュ
- マルチポイント経路（経由地）対応
- マーカー共有機能（URL生成）

### 技術的改善
- PWA化（オフライン対応）
- TypeScript化
- モジュール分割
- テスト自動化

## ライセンス

### 使用ライブラリ
- **Leaflet**: BSD-2-Clause License
- **OpenStreetMap**: Open Database License
- **HTML2Canvas**: MIT License

### 本プロジェクト
- 特定ライセンスなし（学習・個人利用目的）

---

**作成日**: 2025年9月21日  
**バージョン**: 1.1  
**最終更新**: 2025年10月1日
