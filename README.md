# WebMap

Leafletを用いた地図表示・地点管理・ルート検索が可能なWebアプリケーションです。
ブラウザのみで動作し、無料のOSM関連APIを使用するため課金は一切発生しません。

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Leaflet](https://img.shields.io/badge/Leaflet-1.9.4-green.svg)](https://leafletjs.com/)

## 目次

- [デモ](#デモ)
- [概要](#概要)
- [主な機能](#主な機能)
- [使い方](#使い方)
- [注意事項](#注意事項)
- [ブラウザ対応](#ブラウザ対応)
- [ライセンス](#ライセンス)
- [コントリビューション](#コントリビューション)
- [開発者向け技術仕様](#開発者向け技術仕様)

## デモ

🔗 **[WebMapを使ってみる](https://your-username.github.io/web-map-main/)**

※ GitHub Pagesで公開中

## 概要

WebMapは、地図上でのマーカー管理、ルート検索、距離・面積計測などを手軽に行えるWebアプリです。
すべてのデータはブラウザのローカルストレージに保存され、外部サーバーへの送信は行いません。

### 特徴

- **完全無料**: OpenStreetMap、OSRM、Nominatim APIを使用し、課金なし
- **プライバシー重視**: データはすべてローカル保存、外部送信なし
- **シンプル**: ブラウザだけで動作、特別な環境構築不要
- **多機能**: マーカー管理、ルート検索、距離・面積計測、地域メッシュコード表示

## 主な機能

### 🗺️ 地図表示・操作
- 地図クリックで緯度・経度と**地域メッシュコード**（1/2メッシュ：9桁、約500m四方）を表示
- 東京・大阪・京都への瞬時移動ボタン
- 住所検索による地図移動
- 現在地表示（Geolocation API、精度円付き）

### 📍 マーカー管理
- 9種類のカスタムアイコン（📍デフォルト、🏠家、🏢職場、🍽️レストラン、🛒ショップ、🏥病院、🏫学校、🌳公園、⭐お気に入り）
- マーカーの追加・編集・削除
- アイコン種類によるフィルター表示
- JSON形式でのエクスポート・インポート
- ブラウザのローカルストレージに自動保存

### 🚗 ルート検索
- 出発地・到着地を設定してルート自動計算（OSRM API使用）
- 距離・所要時間の表示
- ルートの地図上可視化

### 📏 計測機能
- 距離計測（折れ線）
- 面積計測（ポリゴン、周長も表示）
- メートル/キロメートル自動切り替え

### 📷 その他
- 地図の画像保存（PNG形式、html2canvas使用）

## 使い方

### Webアプリとして使用（推奨）

GitHub Pagesで公開中のため、ブラウザでアクセスするだけで利用できます。

1. [デモサイト](https://your-username.github.io/web-map-main/)にアクセス
2. 地図上をクリックしてマーカーを追加
3. 各種ボタンから機能を利用

### ローカル開発環境で使用

リポジトリをクローンしてローカルで実行する場合：

```bash
# リポジトリをクローン
git clone https://github.com/your-username/web-map-main.git
cd web-map-main

# Pythonサーバーを起動
python3 server.py

# ブラウザで http://localhost:8000/ にアクセス
```

ポート変更: `python3 server.py 8080`

## 注意事項

- **インターネット接続**: ルート検索・住所検索には接続が必要です
- **API利用制限**: 外部APIの利用制限に達した場合は時間をおいて再試行してください
- **現在地取得**: HTTPS環境（またはlocalhost）でのみ動作し、ブラウザの位置情報許可が必要です
- **データの保存**: マーカー情報はブラウザのローカルストレージに保存されます（別ブラウザとの共有にはJSONエクスポート/インポートを使用）

## ブラウザ対応

- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

※ JavaScript ES6+、localStorage、Geolocation API、HTML5 Canvasが必要です

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

### 使用ライブラリ

- [Leaflet](https://leafletjs.com/) - BSD-2-Clause License
- [OpenStreetMap](https://www.openstreetmap.org/) - Open Database License
- [HTML2Canvas](https://html2canvas.hertzen.com/) - MIT License
- [Nominatim API](https://nominatim.org/) - 無料、APIキー不要
- [Project OSRM](http://project-osrm.org/) - 無料、APIキー不要

## コントリビューション

バグ報告や機能提案は[Issues](https://github.com/your-username/web-map-main/issues)へお願いします。
プルリクエストも歓迎します。

---

# 開発者向け技術仕様

## 技術仕様

### フロントエンド
- **HTML5**: セマンティックマークアップ
- **CSS3**: レスポンシブデザイン、Flexbox、Grid Layout
- **JavaScript (ES6+)**: モジュラー設計、非同期処理
- **Leaflet.js v1.9.4**: 地図表示ライブラリ
- **HTML2Canvas v1.4.1**: スクリーンショット機能

### バックエンド
- **Python 3.x**: ローカルHTTPサーバー
- **http.server**: 標準ライブラリによる軽量サーバー

### データストレージ
- **localStorage**: ブラウザ内データ永続化
- **JSON**: データ交換フォーマット

### 外部API
- **OpenStreetMap**: 地図タイル（無料）
- **Nominatim API**: 住所検索（無料、APIキー不要）
- **Project OSRM**: ルート検索（無料、APIキー不要、HTTPSアクセス）

## ファイル構成

```
web-map-main/
├── index.html          # メインHTMLファイル
├── map.js             # JavaScriptロジック
├── style.css          # スタイルシート
├── server.py          # ローカル開発用Pythonサーバー
├── README.md          # 本ドキュメント
└── LICENSE            # MITライセンス
```

※ GitHub Pagesでは`index.html`がエントリーポイントとして自動的に配信されます

## 機能仕様

### 地図表示機能
- **地図エンジン**: Leaflet.js + OpenStreetMap
- **初期表示**: 東京（35.6762, 139.6503）、ズームレベル10
- **操作**: ドラッグ移動、ズーム、クリック
- **レスポンシブ**: PC・タブレット・スマートフォン対応

### 住所検索機能
- **検索API**: Nominatim（OpenStreetMap）
- **対応言語**: 日本語
- **検索方式**: 段階的検索（完全一致→部分一致→単語分割）
- **検索結果**: 最大5件表示
- **操作**: 検索ボックス入力 + Enterキーまたは検索ボタン

### マーカー機能

#### マーカー作成
- **トリガー**: 地図上クリック
- **設定項目**:
  - タイトル（必須）
  - 説明（任意）
  - アイコン選択（9種類）
- **表示**: カスタムアイコン + タイトルラベル

#### アイコン種類
| アイコン | 用途 | カラー |
|---------|------|--------|
| 📍 | デフォルト | 赤 |
| 🏠 | 家 | 緑 |
| 🏢 | 職場 | 青 |
| 🍽️ | レストラン | オレンジ |
| 🛒 | ショップ | 紫 |
| 🏥 | 病院 | 赤 |
| 🏫 | 学校 | グレー |
| 🌳 | 公園 | 緑 |
| ⭐ | お気に入り | 黄 |

#### マーカー編集
- **編集方法**: マーカークリック or 管理画面
- **編集可能項目**: タイトル、説明、アイコン
- **削除**: 個別削除（確認ダイアログ付き）

### マーカー管理機能

#### データ永続化
- **保存方式**: localStorage
- **保存タイミング**: 作成・編集・削除時に自動保存
- **データ形式**: JSON

#### マーカー一覧
- **表示内容**: アイコン、タイトル、説明、座標
- **操作**: 移動、編集、削除

#### インポート/エクスポート
- **エクスポート**: JSONファイルとしてダウンロード
- **インポート**: JSONファイルから復元
- **ファイル名形式**: `webmap_markers_YYYYMMDD_HHMM.json`

### 画像保存機能
- **方式**: HTML2Canvasによるスクリーンショット
- **対象**: 地図とマーカーのみ（UI要素は非表示）
- **形式**: PNG
- **ファイル名**: `webmap_YYYYMMDD_HHMMSS.png`

### 都市移動機能
- **プリセット都市**: 東京、大阪、京都
- **ズームレベル**: 12
- **マーカー**: 都市名付きマーカーを自動設置

### 現在地ジャンプ機能
- **取得方式**: Geolocation API（高精度オプション有効）
- **表示内容**: 現在地マーカー + 精度円（±m表記）
- **ズーム**: 精度値に応じて自動調整（14〜16）
- **制約**: HTTPSまたは`localhost`アクセス時のみ利用可能

### 距離・面積計測機能
- **モード**: 距離計測（折れ線）、面積計測（ポリゴン）
- **操作**: 対象モードを選択 → 地図クリックで頂点追加 → 結果は情報パネルに表示
- **結果表示**:
  - 距離: メートル／キロメートル自動切り替え
  - 面積: 平方メートル／平方キロメートル自動切り替え
  - 周長: 面積計測時に同時表示
- **リセット**: 計測リセットボタンでクリア

### ルートガイド機能
- **API**: Project OSRM（driving profile）
- **操作手順**:
  1. 出発地ボタンを押下し地図上をクリック
  2. 到着地ボタンを押下し地図上をクリック
  3. ルート表示ボタンで経路取得（自動でも起動）
- **表示**: ルートポリライン、距離・所要時間を情報パネルに表示
- **補助**: ルートクリアボタンでポイント／ポリラインを削除

### マーカーフィルター機能
- **対象**: 9種類のマーカーアイコン
- **操作**: フィルタードロップダウンで種類選択、フィルター解除ボタンで全表示
- **反映範囲**: 地図上のマーカー、マーカー管理ダイアログ、情報パネルの件数
- **状態表示**: 「マーカー表示」欄に現在の絞り込み状況と件数を表示

### 地域メッシュコード表示機能
- **メッシュコード体系**: 日本の地域メッシュ統計（JIS X 0410）準拠
- **表示形式**: 9桁の1/2メッシュコード（約500m四方）
- **計算方式**:
  - 1次メッシュ（4桁）: 約80km四方
  - 2次メッシュ（6桁）: 約10km四方
  - 3次メッシュ（8桁）: 約1km四方
  - 1/2メッシュ（9桁）: 約500m四方（3次メッシュを2×2分割）
- **表示位置**: 情報パネル内「メッシュコード」欄
- **更新タイミング**: 地図上をクリックした際に自動計算・表示

## ユーザーインターフェース

### コントロールパネル（左上）
- 東京 / 大阪 / 京都 ボタン（緑）
- マーカーをクリアボタン（赤）
- マーカーフィルター選択（ドロップダウン + 解除ボタン）
- ルート制御（出発地 / 到着地 / ルート表示 / ルートクリア）
- 計測制御（距離計測 / 面積計測 / 計測リセット）
- 📍 現在地ボタン（青）
- 📷 画像保存ボタン（紫）
- 📋 マーカー管理ボタン（オレンジ）

### 検索ボックス（右上）
- 住所入力フィールド
- 検索ボタン
- 検索結果表示エリア

### 情報パネル（右下）
- クリック位置（緯度・経度を6桁精度で表示）
- メッシュコード（9桁の1/2メッシュコード）
- ズームレベル
- 現在地ステータス（成功／失敗／未取得）
- 計測結果（距離・面積・周長）
- マーカー表示状態（フィルター種別・件数）
- ルート結果（距離・所要時間）

### ダイアログ
- **マーカー設定ダイアログ**: タイトル、説明、アイコン選択
- **マーカー管理ダイアログ**: 一覧表示、インポート/エクスポート

## データ構造

### マーカーデータ
```json
{
  "id": 1,
  "title": "マーカータイトル",
  "description": "マーカーの説明",
  "iconType": "home",
  "emoji": "🏠",
  "lat": 35.6762,
  "lng": 139.6503
}
```

### 都市データ
```javascript
const CITIES = {
  tokyo: { lat: 35.6762, lng: 139.6503, name: '東京' },
  osaka: { lat: 34.6937, lng: 135.5023, name: '大阪' },
  kyoto: { lat: 35.0116, lng: 135.7681, name: '京都' }
};
```

## パフォーマンス最適化

### フロントエンド最適化
- **DOM要素キャッシュ**: 頻繁に使用する要素をメモリに保持
- **イベント委譲**: 効率的なイベント処理
- **デバウンス処理**: 過度なイベント発火の抑制
- **バッチ処理**: 複数マーカーの一括操作

### ネットワーク最適化
- **プリコネクト**: CDNへの事前接続
- **遅延読み込み**: 必要時のみリソース取得
- **キャッシュ活用**: ブラウザキャッシュの有効利用

## セキュリティ考慮事項

### データ保護
- **ローカルストレージ**: 機密情報は保存しない
- **XSS対策**: ユーザー入力のサニタイズ
- **CORS設定**: 適切なオリジン制御

### プライバシー
- **位置情報**: ユーザーの明示的な許可後のみ取得
- **データ送信**: 外部サーバーへの個人データ送信なし

## ブラウザサポート

### 対応ブラウザ
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### 必要機能
- ES6+ JavaScript
- localStorage
- Geolocation API（位置情報取得時）
- HTML5 Canvas（スクリーンショット時）

## エラーハンドリング

### 地図読み込みエラー
- エラーメッセージ表示
- 代替タイルサーバーへの切り替え

### 検索エラー
- ネットワークエラー時の再試行
- 検索結果なしの適切な表示

### データ保存エラー
- localStorage容量不足の検出
- ユーザーへの警告表示

## 今後の拡張可能性

### 機能拡張
- 地図スタイル切り替え（ライト／ダーク）
- オフライン閲覧用タイルキャッシュ
- マルチポイント経路（経由地）対応
- マーカー共有機能（URL生成）

### 技術的改善
- PWA化（オフライン対応）
- TypeScript化
- モジュール分割
- テスト自動化

---

## 謝辞

このプロジェクトは以下のオープンソースプロジェクトと無料サービスによって支えられています：
- OpenStreetMapコミュニティ
- Leaflet.js開発チーム
- Project OSRMプロジェクト
- Nominatim API

---

**バージョン**: 1.2
**最終更新**: 2024年10月
